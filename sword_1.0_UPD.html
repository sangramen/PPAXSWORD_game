<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ì†Œë“œ ê°•í™” ê²Œì„ - ì‹¤ì‹œê°„ ë­í‚¹</title>
<style>
body { font-family:'Arial',sans-serif; text-align:center; margin-top:30px; }
#gameArea,#rankingBox{display:none;}
#intro{margin-top:100px;}
#intro button{font-size:32px; padding:24px 60px; margin-top:30px; cursor:pointer;}
#shopButton{position:fixed; top:48px; left:10px; background-color:#28a745; color:white; border:none; padding:15px 30px; font-size:52px; font-weight:bold; border-radius:6px; cursor:pointer; display:none; z-index:999;}
#shopArea{display:none; margin-top:50px;}
button{cursor:pointer;}
img{margin:20px;}
#buyProtectBtn{font-size:20px; padding:12px 30px; margin-top:20px; cursor:pointer;}
.gameControl{display:none;}
#infoBox{display:none; position:absolute; top:60px; right:50px; width:320px; height:450px; border:2px solid #333; border-radius:8px; padding:15px; font-size:20px; text-align:left; background:#f7f7f7; box-shadow:2px 2px 8px rgba(0,0,0,0.2);}
#gameOverScreen{display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:black; justify-content:center; align-items:center; flex-direction:column; z-index:9999;}
#gameOverVideo{max-width:80%; max-height:80%;}
</style>
</head>
<body>

<div id="intro">
<h1>ì†Œë“œ ê°•í™” ì‹œë®¬ë ˆì´í„°</h1>
<button onclick="startGame()">ê²Œì„ ì‹œì‘</button>
</div>

<button id="shopButton" onclick="openShop()">ìƒì </button>

<div id="gameArea">
<h2>í™˜ì˜í•©ë‹ˆë‹¤, <span id="nicknameDisplay"></span> ë‹˜!</h2>
<img id="swordImg" src="sword_lv0.png" width="200" onerror="this.style.display='none'"><br>
<p id="swordName">ê²€ ì´ë¦„: ê·¸ëƒ¥ ì†Œë“œ.</p>
<p>í˜„ì¬ ë ˆë²¨: <span id="currentLevel">0</span></p>
<p>í……ì¥(ì†Œì§€ê¸ˆ): <span id="money">0</span> ì›</p>
<p>ê°•í™”ë¹„ìš©: <span id="enhanceCost">100</span> ì›</p>
<button class="gameControl" onclick="enhanceSword()">ê°•í™”!!!</button>
<button class="gameControl" onclick="sellSword()">ì†Œë“œ íŒë§¤í•˜ê¸°</button>
<h3>ğŸ†ë­í‚¹ğŸ†</h3>
<pre id="rankingBox"></pre>
</div>

<div id="infoBox">
<p style="font-weight:bold; font-size:22px; margin-bottom:8px;">ê°•í™” ì„±ê³µ í™•ë¥ </p>
<p id="successRateDisplay" style="font-size:28px;">100%</p>
<hr style="margin:8px 0;">
<p>í˜„ì¬ ì†Œë“œ íŒë§¤ ê°€ê²©: <span id="currentPriceDisplay">0 ì›</span></p>
<p>ë‹¤ìŒ ë ˆë²¨ íŒë§¤ ê°€ê²©: <span id="nextPriceDisplay">0 ì›</span></p>
<hr style="margin:12px 0;">
<p>í˜„ì¬ ë ˆë²¨: <span id="currentLevelInfo">0</span></p>
<p>í……ì¥(ì†Œì§€ê¸ˆ): <span id="moneyInfo">0</span> ì›</p>
<p id="protectStatus">ê°•í™” ë³´í˜¸ ì•„ì´í…œ: ì—†ìŒ</p>
</div>

<div id="shopArea">
<h2>ìƒì </h2>
<p style="margin-bottom:10px; font-weight:bold;">
ğŸ›¡ï¸ '87ì„¸ ê¹€ë¯¸ì‹œ í• ë¨¸ë‹ˆì˜ ìµœí›„ì˜ ê°‘ì˜·'<br>
íš¨ê³¼: ê°•í™” ì‹¤íŒ¨ ì‹œ ì†Œë“œ íŒŒê´´ 1íšŒ ë°©ì–´
</p>
<button id="buyProtectBtn" onclick="buyProtectItem()">êµ¬ë§¤ (3000ì›)</button><br>
<button onclick="closeShop()" style="margin-top:20px;">ìƒì  ë‚˜ê°€ê¸°</button>
</div>

<div id="gameOverScreen">
<video id="gameOverVideo" src="over.mp4" onerror="this.style.display='none'"></video>
</div>

<!-- íš¨ê³¼ìŒ -->
<audio id="successSound" src="success.mp3" onerror="this.style.display='none'"></audio>
<audio id="failSound" src="fail.mp3" onerror="this.style.display='none'"></audio>
<audio id="enhanceTrySound" src="enhanceTry.mp3" onerror="this.style.display='none'"></audio>
<audio id="buyProtectSound" src="buyProtect.mp3" onerror="this.style.display='none'"></audio>
<audio id="sellSound" src="sell.mp3" onerror="this.style.display='none'"></audio>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const firebaseConfig = {
apiKey: "AIzaSyCEZUoYNe846MbRFYmZQfkH6_Pu8gJGYxM",
authDomain: "swordenhancegame.firebaseapp.com",
databaseURL: "https://swordenhancegame-default-rtdb.firebaseio.com/",
projectId: "swordenhancegame",
storageBucket: "swordenhancegame.firebasestorage.app",
messagingSenderId: "452889860113",
appId: "1:452889860113:web:fb018e74cedab080db39b0",
measurementId: "G-F8BJC35Q24"
};
const app = firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let gameStarted=false;
let level=0,nickname='',highScore=0,money=2500,protectCount=0;
const successRates=[1,0.95,0.9,0.85,0.8,0.75,0.7,0.65,0.6,0.55,0.5,0.45,0.4,0.35,0.3];
const swordNames=["ê·¸ëƒ¥ ì†Œë“œ.","ëª©ê²€ ì†Œë“œ","ë‚ ì¹´ë¡œìš´ ì†Œë“œ","ì§±ìˆ ì†Œë“œ","ì‚¬ì¶˜ê¸° ì†Œë“œ","ì¹´ì´ë‹¤ ì†Œë“œ","PRETTY ì†Œë“œ","ë‚œìŸì´ë˜¥ìë£¨ ì†Œë“œ","ì„íƒ„ ì½”ìŠ¤í”„ë ˆ","ê°œë°œì ë¨¹ëŠ” ì†Œë“œ","ë¹„ë‘˜ê¸° ì†Œë“œ","ë‚œìŸì´ëª©ê²€ ì†Œë“œ","íƒˆëª¨ì˜¨ ì†Œë“œ(beta)","ë©”ì´ë“œ ì†Œë“œ","ì—‘ìŠ¤ì¹¼ë¦¬ë²„ ì†Œë“œ"];

function getEnhanceCost(l){return Math.floor(100*Math.pow(1.25,l));}
function isSuccess(){return Math.random()<(successRates[level]??0.1);}
function getSellPrice(l){if(l===1)return 100;if(l===2)return 250;if(l===3)return 1000;let p=1000;for(let i=4;i<=l;i++)p*=2;return p;}

function updateUI(){
document.getElementById('successRateDisplay').textContent=`${((successRates[level]??0.1)*100).toFixed(1)}%`;
document.getElementById('currentPriceDisplay').textContent=`${getSellPrice(level)} ì›`;
document.getElementById('nextPriceDisplay').textContent=`${getSellPrice(level+1)} ì›`;
document.getElementById('currentLevel').textContent=level;
document.getElementById('currentLevelInfo').textContent=level;
document.getElementById('money').textContent=money;
document.getElementById('moneyInfo').textContent=money;
document.getElementById('protectStatus').textContent=protectCount>0?`ê°•í™” ë³´í˜¸ ì•„ì´í…œ: ${protectCount}ê°œ`:"ê°•í™” ë³´í˜¸ ì•„ì´í…œ: ì—†ìŒ";
document.getElementById('swordImg').src=`sword_lv${Math.min(level,13)}.png`;
document.getElementById('swordName').textContent=`ê²€ ì´ë¦„: ${swordNames[Math.min(level,swordNames.length-1)]}`;
document.getElementById('enhanceCost').textContent=getEnhanceCost(level);
checkGameOver();
}

function startGame(){
nickname=prompt('ë‹‰ë„¤ì„ ì…ë ¥ (ìµœëŒ€ 30ì)');
if(!nickname||nickname.length>30){alert("ë‹‰ë„¤ì„ì€ 30ì ì´í•˜!"); return;}
nickname=nickname.replace(/</g,"&lt;").replace(/>/g,"&gt;"); // XSS ì˜ˆë°©
document.getElementById('nicknameDisplay').textContent=nickname;
document.getElementById('intro').style.display='none';
document.getElementById('gameArea').style.display='block';
document.getElementById('shopButton').style.display='block';
document.getElementById('infoBox').style.display='block';
document.querySelectorAll('.gameControl').forEach(b=>b.style.display='inline-block');
gameStarted=true;

// Firebase ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
db.ref('players/'+nickname).once('value')
.then(snapshot=>{
const data=snapshot.val();
if(data){level=data.level; money=data.money; protectCount=data.protectCount||0; highScore=data.highScore||level;}
updateUI();
})
.catch(err=>{console.warn("Firebase load fail:",err); updateUI(); });

// ì‹¤ì‹œê°„ ë­í‚¹
db.ref("ranking").orderByChild("score").limitToLast(10)
.on("value", snapshot=>{
let list=""; let arr=[];
snapshot.forEach(child=>arr.push(child.val()));
arr.sort((a,b)=>b.score-a.score);
arr.forEach(d=>list+=`${d.nickname} : ${d.score}<br>`);
document.getElementById("rankingBox").innerHTML=list;
});
}

function enhanceSword(){
const cost=getEnhanceCost(level);
if(money<cost){alert(`ê°•í™”ë¹„ìš© ${cost}ì›ì´ ë¶€ì¡±!`); return;}
money-=cost; playEnhanceTrySound();
if(isSuccess()){level++; if(level>highScore)highScore=level; playSound(true); alert(`ì„±ê³µ! ë ˆë²¨+${level}`);}
else{if(protectCount>0){protectCount--; alert("ë³´í˜¸ ì•„ì´í…œ ë•ë¶„ì— íŒŒê´´ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");} else{level=0; alert("ì‹¤íŒ¨! ì†Œë“œ íŒŒê´´");} playSound(false);}
savePlayerState(); saveHighScore(); updateUI();
}

function sellSword(){
if(level<1){alert("ë ˆë²¨ 0 ì†Œë“œëŠ” íŒë§¤ ë¶ˆê°€"); return;}
const price=getSellPrice(level); money+=price; level=0;
alert(`${price}ì› íšë“!`); playSellSound(); updateUI(); savePlayerState(); saveHighScore();
}

function buyProtectItem(){if(money<3000){alert("3000ì› ë¶€ì¡±"); return;} money-=3000; protectCount++; alert("ë³´í˜¸ ì•„ì´í…œ êµ¬ë§¤!"); playBuyProtectSound(); savePlayerState();}

function savePlayerState(){try{db.ref('players/'+nickname).set({level,money,protectCount,highScore});}catch(e){console.warn(e);}}
function saveHighScore(){try{db.ref('ranking/'+nickname).set({nickname,score:highScore});}catch(e){console.warn(e);}}

function playEnhanceTrySound(){const s=document.getElementById('enhanceTrySound'); if(s){s.currentTime=0; s.play().catch(()=>{});}}
function playSound(success){const s=document.getElementById(success?'successSound':'failSound'); if(s){s.currentTime=0; s.play().catch(()=>{});}}
function playSellSound(){const s=document.getElementById('sellSound'); if(s){s.currentTime=0; s.play().catch(()=>{});}}
function playBuyProtectSound(){const s=document.getElementById('buyProtectSound'); if(s){s.currentTime=0; s.play().catch(()=>{});}}

function openShop(){document.getElementById('gameArea').style.display='none'; document.getElementById('rankingBox').style.display='none'; document.getElementById('shopArea').style.display='block'; document.getElementById('shopButton').style.display='none';}
function closeShop(){document.getElementById('shopArea').style.display='none'; document.getElementById('gameArea').style.display='block'; document.getElementById('rankingBox').style.display='block'; document.getElementById('shopButton').style.display='block'; updateUI();}

function checkGameOver(){if(!gameStarted) return; if(money<225 && level===0){triggerGameOver();}}
function triggerGameOver(){
const screen=document.getElementById('gameOverScreen');
const video=document.getElementById('gameOverVideo');
screen.style.display='flex';
video.play().catch(()=>{}); // ì˜ìƒ ì—†ìœ¼ë©´ ë„˜ì–´ê°
video.onended=()=>{level=0; money=2500; protectCount=0; updateUI(); alert("GAME OVER - ë‹¤ì‹œ ì‹œì‘ ê°€ëŠ¥"); screen.style.display='none';}
}
</script>
</body>
</html>
